---
import MainLayout from "../../layouts/MainLayout.astro";
import BackButton from "../../components/BackButton.astro";
---

<MainLayout title="Detalle del Plan" layoutMode="app">
    <div class="w-full py-4 px-3 overflow-x-hidden">
        <div id="loading" class="text-center py-20">
            <div
                class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary-500 border-t-transparent"
            >
            </div>
            <p class="mt-2 text-slate-500">Cargando detalles...</p>
        </div>

        <div id="content" class="hidden">
            <div
                class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4"
            >
                <div>
                    <BackButton href="/dashboard" />
                    <h1
                        id="project-name"
                        class="text-4xl font-black text-slate-900 tracking-tight"
                    >
                        Nombre del Proyecto
                    </h1>
                    <p id="project-sector" class="text-slate-400 font-medium">
                        Sector Económico
                    </p>
                </div>

                <div class="flex gap-3">
                    <button
                        id="export-btn"
                        class="btn btn-primary flex items-center bg-green-600 hover:bg-green-700 shadow-lg shadow-green-100"
                    >
                        <svg
                            class="w-5 h-5 mr-2"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"
                            ></path>
                        </svg>
                        Descargar Word
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-4 gap-[15px]">
                <!-- Main Content -->
                <div class="lg:col-span-3 space-y-4">
                    <!-- General Description -->
                    <div class="card p-6">
                        <h3
                            class="text-xl font-bold mb-4 border-b border-slate-100 pb-2"
                        >
                            Resumen del Proyecto
                        </h3>
                        <p
                            id="project-description"
                            class="text-slate-600 leading-relaxed italic"
                        >
                        </p>
                    </div>

                    <!-- Strategic Analysis -->
                    <div class="card p-6">
                        <h3
                            class="text-xl font-bold mb-4 border-b border-slate-100 pb-2 flex items-center"
                        >
                            <svg
                                class="w-6 h-6 mr-2 text-indigo-500"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                                ><path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                                ></path></svg
                            >
                            Análisis Estratégico
                        </h3>
                        <div class="grid grid-cols-1 gap-6">
                            <div class="col-span-full">
                                <h4
                                    class="font-black text-slate-900 text-xs uppercase mb-2 tracking-widest"
                                >
                                    Actividad Principal
                                </h4>
                                <p
                                    id="main-activity"
                                    class="text-slate-800 text-sm leading-relaxed"
                                >
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Market & Canvas -->
                    <div class="card p-6">
                        <h3
                            class="text-xl font-bold mb-4 border-b border-slate-100 pb-2 flex items-center"
                        >
                            <svg
                                class="w-6 h-6 mr-2 text-indigo-500"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                                ><path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                                ></path></svg
                            >
                            Mercado y Modelo
                        </h3>
                        <div class="space-y-6">
                            <div class="col-span-full">
                                <h4
                                    class="font-black text-slate-900 text-xs uppercase mb-2 tracking-widest"
                                >
                                    Propuesta de Valor
                                </h4>
                                <p
                                    id="value-proposition"
                                    class="text-slate-800 text-sm leading-relaxed"
                                >
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Channels -->
                    <div class="card p-6">
                        <h3
                            class="text-xl font-bold mb-4 border-b border-slate-100 pb-2 flex items-center"
                        >
                            <svg
                                class="w-6 h-6 mr-2 text-indigo-500"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                                ><path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                                ></path></svg
                            >
                            Canales de Comunicación y Comercialización
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h4
                                    class="font-bold text-slate-700 text-sm uppercase mb-1"
                                >
                                    Comunicación
                                </h4>
                                <p
                                    id="comm-channels"
                                    class="text-slate-600 text-sm"
                                >
                                </p>
                            </div>
                            <div>
                                <h4
                                    class="font-bold text-slate-700 text-sm uppercase mb-1"
                                >
                                    Comercialización
                                </h4>
                                <p
                                    id="com-channels"
                                    class="text-slate-600 text-sm"
                                >
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Relational Tables -->
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <!-- Team -->
                        <div class="card p-6">
                            <h3
                                class="text-lg font-bold mb-4 border-b border-slate-100 pb-2"
                            >
                                Equipo de Trabajo
                            </h3>
                            <div
                                id="team-table"
                                class="overflow-x-auto min-h-[100px]"
                            >
                            </div>
                        </div>
                        <!-- Partners -->
                        <div class="card p-6">
                            <h3
                                class="text-lg font-bold mb-4 border-b border-slate-100 pb-2"
                            >
                                Aliados Clave
                            </h3>
                            <div
                                id="partners-table"
                                class="overflow-x-auto min-h-[100px]"
                            >
                            </div>
                        </div>
                    </div>

                    <!-- Customer Segments -->
                    <div class="card p-6">
                        <h3
                            class="text-xl font-bold mb-4 border-b border-slate-100 pb-2 flex items-center"
                        >
                            <svg
                                class="w-6 h-6 mr-2 text-indigo-500"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                                ><path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"
                                ></path></svg
                            >
                            Segmentos de Clientes
                        </h3>
                        <div id="segments-table" class="overflow-x-auto"></div>
                    </div>

                    <!-- Supply Chain -->
                    <div class="card p-6">
                        <h3
                            class="text-xl font-bold mb-4 border-b border-slate-100 pb-2"
                        >
                            Cadena de Suministro
                        </h3>
                        <div id="supply-chain-content"></div>
                    </div>

                    <!-- Financial Detailed Tables -->
                    <div class="space-y-8">
                        <div class="card p-6">
                            <h3
                                class="text-lg font-bold mb-4 border-b border-slate-100 pb-2 text-indigo-700"
                            >
                                Costos Unitarios de Producción
                            </h3>
                            <div id="unit-costs-table" class="overflow-x-auto">
                            </div>
                        </div>
                        <div class="card p-6">
                            <h3
                                class="text-lg font-bold mb-4 border-b border-slate-100 pb-2"
                            >
                                Demanda Mensual
                            </h3>
                            <div id="demand-table" class="overflow-x-auto">
                            </div>
                        </div>
                        <div class="card p-6">
                            <h3
                                class="text-lg font-bold mb-4 border-b border-slate-100 pb-2"
                            >
                                Inversión en Equipos
                            </h3>
                            <div id="equipment-table" class="overflow-x-auto">
                            </div>
                        </div>
                        <div class="card p-6">
                            <h3
                                class="text-lg font-bold mb-4 border-b border-slate-100 pb-2"
                            >
                                Provisiones (Gastos Administrativos y Ventas)
                            </h3>
                            <div id="provisions-table" class="overflow-x-auto">
                            </div>
                        </div>
                        <div class="card p-6">
                            <h3
                                class="text-lg font-bold mb-4 border-b border-slate-100 pb-2"
                            >
                                Plan de Financiamiento
                            </h3>
                            <div id="financing-table" class="overflow-x-auto">
                            </div>
                        </div>
                    </div>

                    <!-- Projections -->
                    <div class="card p-6">
                        <h3
                            class="text-xl font-bold mb-4 border-b border-slate-100 pb-2"
                        >
                            Proyección Financiera (5 Años)
                        </h3>
                        <div
                            id="projections-table"
                            class="overflow-x-auto custom-scrollbar"
                        >
                        </div>
                    </div>

                    <!-- Annexes Gallery -->
                    <div class="card p-6">
                        <h3
                            class="text-xl font-bold mb-4 border-b border-slate-100 pb-2 flex items-center"
                        >
                            <svg
                                class="w-6 h-6 mr-2 text-indigo-500"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                                ><path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                                ></path></svg
                            >
                            Anexos y Evidencias
                        </h3>
                        <div
                            id="images-gallery"
                            class="grid grid-cols-2 md:grid-cols-4 gap-4"
                        >
                        </div>
                    </div>
                </div>

                <!-- Sidebar Summary -->
                <div class="space-y-6">
                    <!-- Viability Indicators -->
                    <div
                        class="card p-6 bg-indigo-900 text-white border-indigo-800 shadow-indigo-200/50"
                    >
                        <h3 class="text-lg font-bold mb-6 flex items-center">
                            <svg
                                class="w-5 h-5 mr-2"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24"
                                ><path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"
                                ></path></svg
                            >
                            Viabilidad
                        </h3>
                        <div class="space-y-4">
                            <div
                                class="flex justify-between items-center text-sm"
                            >
                                <span
                                    class="text-indigo-300 font-bold uppercase tracking-tighter"
                                    >Utilidad Neta (Año 1)</span
                                >
                                <span
                                    id="summary-profit"
                                    class="font-mono text-xl font-black text-green-400"
                                ></span>
                            </div>
                            <div
                                class="flex justify-between items-center text-sm border-t border-indigo-800 pt-3"
                            >
                                <span
                                    class="text-indigo-300 font-bold uppercase tracking-tighter"
                                    >Inversión Inicial</span
                                >
                                <span
                                    id="summary-investment"
                                    class="font-mono text-lg font-bold text-white"
                                ></span>
                            </div>
                            <div class="h-px bg-indigo-800 my-2"></div>
                            <div
                                class="flex justify-between items-center text-sm"
                            >
                                <span class="text-indigo-300">VAN</span>
                                <span
                                    id="van-result"
                                    class="font-mono text-lg font-bold"></span>
                            </div>
                            <div
                                class="flex justify-between items-center text-sm"
                            >
                                <span class="text-indigo-300">TIR</span>
                                <span
                                    id="tir-result"
                                    class="font-mono text-lg font-bold"></span>
                            </div>
                            <div
                                class="flex justify-between items-center text-sm"
                            >
                                <span class="text-indigo-300">Relación B/C</span
                                >
                                <span
                                    id="bc-result"
                                    class="font-mono text-lg font-bold"></span>
                            </div>
                            <div
                                class="flex justify-between items-center text-sm border-t border-indigo-800 pt-3"
                            >
                                <span class="text-indigo-300">Recuperación</span
                                >
                                <span id="payback-result" class="font-medium"
                                ></span>
                            </div>
                        </div>
                    </div>

                    <!-- Automatic Conclusion -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold mb-3">Conclusión</h3>
                        <p
                            id="financial-conclusion"
                            class="text-slate-600 text-sm leading-relaxed italic"
                        >
                        </p>
                    </div>

                    <!-- Rates Setup -->
                    <div class="card p-6 bg-[#FAFAFA] border-slate-100">
                        <h3
                            class="text-sm font-bold text-slate-500 uppercase mb-4 tracking-wider"
                        >
                            Tasas Aplicadas
                        </h3>
                        <div class="space-y-3">
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500"
                                    >Crecimiento Demanda</span
                                >
                                <span id="rate-growth" class="font-bold"></span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500"
                                    >Crecimiento Precios</span
                                >
                                <span id="rate-price-growth" class="font-bold"
                                ></span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500">Inflación</span>
                                <span id="rate-inflation" class="font-bold"
                                ></span>
                            </div>
                            <div class="flex justify-between text-xs">
                                <span class="text-slate-500"
                                    >Incremento Salarial</span
                                >
                                <span
                                    id="rate-salary-increase"
                                    class="font-bold"></span>
                            </div>
                            <div
                                class="flex justify-between text-xs border-t border-slate-100 pt-2 mt-2"
                            >
                                <span class="text-indigo-600 font-bold"
                                    >Descuento</span
                                >
                                <span
                                    id="rate-discount"
                                    class="font-bold text-indigo-600"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Documents -->
                    <div class="card p-6">
                        <h3 class="text-lg font-bold mb-4">Descargas</h3>
                        <ul id="documents-list" class="space-y-3"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Security Confirmation Modal HTML -->
    <dialog id="security_confirm_modal" class="modal">
        <div
            class="modal-box bg-white p-0 rounded-[20px] max-w-md w-full overflow-hidden shadow-2xl border border-slate-100"
        >
            <div
                class="p-6 border-b flex justify-between items-center"
                class="p-6 border-b flex justify-between items-center bg-slate-50/50"
            >
                <h3 class="text-xl font-black text-slate-900">
                    Confirmar Acción
                </h3>
                <button
                    type="button"
                    class="btn btn-ghost btn-sm btn-circle"
                    id="btn-close-security-modal">✕</button
                >
            </div>

            <div class="p-8">
                <div
                    class="w-12 h-12 bg-red-50 text-red-600 rounded-full flex items-center justify-center mb-6"
                >
                    <svg
                        class="w-6 h-6"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 00-2 2zm10-10V7a4 4 0 00-8 0v4h8z"
                        ></path>
                    </svg>
                </div>

                <p class="text-slate-500 font-medium mb-6 leading-relaxed">
                    Para continuar, por favor ingresa tu contraseña de inicio de
                    sesión. Esta acción no se puede deshacer.
                </p>

                <form id="security-confirm-form" class="space-y-4">
                    <input type="hidden" id="security-action-type" />
                    <input type="hidden" id="security-target-id" />

                    <div>
                        <label
                            class="block text-sm font-bold text-slate-700 mb-2"
                            >Tu Contraseña</label
                        >
                        <input
                            type="password"
                            id="security-password"
                            class="input w-full"
                            placeholder="••••••••"
                            required
                        />
                        <p
                            id="security-error"
                            class="mt-2 text-sm font-bold text-red-600 hidden flex items-center gap-1"
                        >
                            <svg
                                class="w-4 h-4"
                                fill="currentColor"
                                viewBox="0 0 20 20"
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z"
                                    clip-rule="evenodd"></path>
                            </svg>
                            Contraseña incorrecta
                        </p>
                    </div>

                    <div class="flex flex-col gap-3 pt-2">
                        <button
                            type="submit"
                            id="security-submit-btn"
                            class="w-full h-14 bg-red-600 hover:bg-red-700 text-white font-black rounded-xl shadow-lg shadow-red-200 transition-all flex items-center justify-center gap-2 active:scale-95"
                        >
                            <span>Confirmar y Eliminar</span>
                        </button>
                        <button
                            type="button"
                            id="security-cancel-btn"
                            class="w-full h-14 text-slate-500 font-bold hover:bg-slate-50 rounded-xl transition-all"
                        >
                            Cancelar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </dialog>
</MainLayout>

<script>
    import { api } from "../../lib/api";

    const planId = window.location.pathname.split("/").pop();

    async function loadPlan() {
        try {
            if (!planId) return;
            const plan = await api.getPlan(parseInt(planId));
            const ent = plan.entrepreneurship;

            // Basic Info
            const setSafe = (id: string, text: string) => {
                const el = document.getElementById(id);
                if (el) el.innerText = text;
            };

            setSafe("project-name", ent.name);
            setSafe("project-sector", ent.sector);
            setSafe(
                "project-description",
                plan.businessDescription || "Sin descripción disponible.",
            );

            // Strategic (Combined into one extended field)
            const extendedActivity = [
                plan.mainActivity,
                plan.productiveFocus,
                plan.socialImpact,
            ]
                .filter((s) => s && s !== "N/A" && s.trim() !== "")
                .join(". ");
            setSafe(
                "main-activity",
                extendedActivity || "Sin actividad registrada.",
            );

            // Canvas (Combined into one extended field)
            const extendedCanvas = [
                plan.valueProposition,
                plan.differentiation,
                plan.customerBenefits,
            ]
                .filter((s) => s && s !== "N/A" && s.trim() !== "")
                .join(". ");
            setSafe(
                "value-proposition",
                extendedCanvas || "Sin propuesta registrada.",
            );

            // Channels
            setSafe("comm-channels", plan.communicationChannels || "N/A");
            setSafe("com-channels", plan.commercializationChannels || "N/A");

            // Formatting
            const format = (n: any) =>
                new Intl.NumberFormat("en-US", {
                    style: "currency",
                    currency: "USD",
                }).format(parseFloat(n) || 0);

            // Relational Tables
            renderSimpleTable(
                "team-table",
                ent.team,
                ["Nombre", "Rol", "Experiencia"],
                ["name", "role", "experience"],
            );
            renderSimpleTable(
                "partners-table",
                ent.partners,
                ["Nombre", "Tipo"],
                ["name", "type"],
            );
            renderSimpleTable(
                "segments-table",
                ent.segments,
                ["Segmento", "%", "Edad", "Nivel S.E.", "Características"],
                [
                    "name",
                    "percentage",
                    "ageRange",
                    "socioeconomicLevel",
                    "characteristics",
                ],
            );

            // Supply Chain logic
            const scContainer = document.getElementById("supply-chain-content");
            if (scContainer) {
                if (
                    plan.supplyChainMode === "IMAGE" &&
                    plan.supplyChainImageUrl
                ) {
                    const imgUrl = plan.supplyChainImageUrl.startsWith("http")
                        ? plan.supplyChainImageUrl
                        : `http://localhost:3000${plan.supplyChainImageUrl}`;
                    scContainer.innerHTML = `<div class="flex flex-col items-center gap-4">
                        <img src="${imgUrl}" alt="Cadena de Suministro" class="max-w-full h-auto rounded-xl shadow-lg border" />
                        <div class="flex flex-col items-center gap-2">
                            <p class="text-xs text-slate-400 italic">Diagrama proporcionado por el usuario</p>
                            <a href="${imgUrl}" target="_blank" class="btn btn-sm btn-ghost text-indigo-600 flex items-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                Ver imagen completa
                            </a>
                        </div>
                    </div>`;
                } else {
                    renderSimpleTable(
                        "supply-chain-content",
                        [
                            {
                                label: "Proveedores",
                                val: plan.supplyChainProviders,
                            },
                            {
                                label: "Producción",
                                val: plan.supplyChainProduction,
                            },
                            {
                                label: "Almacenamiento",
                                val: plan.supplyChainStorage,
                            },
                            {
                                label: "Distribución",
                                val: plan.supplyChainDistribution,
                            },
                            {
                                label: "Cliente Final",
                                val: plan.supplyChainClient,
                            },
                        ],
                        ["Etapa", "Descripción"],
                        ["label", "val"],
                    );
                }
            }

            // Financial Tables
            renderFinancialTable(
                "unit-costs-table",
                plan.unitCosts,
                ["Producto", "Cant. Mes", "V. Unitario", "Total"],
                (u: any) => [
                    u.productName,
                    u.monthlyQuantity,
                    format(u.unitCost),
                    format(u.total),
                ],
            );
            renderFinancialTable(
                "demand-table",
                plan.demands,
                ["Producto", "Demanda Mes", "Precio", "Total"],
                (d: any) => [
                    d.productName,
                    d.monthlyDemand,
                    format(d.unitPrice),
                    format(d.monthlyDemand * d.unitPrice),
                ],
            );
            renderFinancialTable(
                "equipment-table",
                plan.equipments,
                ["Descripción", "Cant", "Precio", "Fuente"],
                (e: any) => [
                    e.description,
                    e.quantity,
                    format(e.unitPrice),
                    e.financingSource,
                ],
            );
            // 7.5: Provisones de Gastos (Grouped by Product ID)
            const provisionsContainer =
                document.getElementById("provisions-table");
            if (provisionsContainer) {
                provisionsContainer.innerHTML = "";
                const unitCosts = plan.unitCosts || [];
                const allProvisions = plan.provisions || [];

                if (unitCosts.length === 0) {
                    provisionsContainer.innerHTML =
                        '<p class="text-slate-400 text-xs italic py-4 text-center">No hay productos registrados que requieran provisiones.</p>';
                } else {
                    unitCosts.forEach((uc: any, idx: number) => {
                        const productProvisions = allProvisions.filter(
                            (p: any) =>
                                String(p.productId) === String(uc.wizardId),
                        );

                        const subTotal = productProvisions.reduce(
                            (acc: number, p: any) =>
                                acc +
                                parseFloat(p.monthlyQuantity) *
                                    parseFloat(p.unitPrice),
                            0,
                        );

                        const sectionHtml = `
                            <div class="mb-10 last:mb-0">
                                <div class="flex items-center gap-3 mb-4">
                                    <span class="flex items-center justify-center w-8 h-8 rounded-xl bg-indigo-600 text-white text-xs font-black shadow-sm shadow-indigo-200">${idx + 1}</span>
                                    <h4 class="text-sm font-black text-slate-800 uppercase tracking-tight">
                                        PRODUCTO: <span class="text-indigo-600">${uc.productName}</span>
                                    </h4>
                                </div>
                                
                                <div class="overflow-x-auto rounded-2xl border border-slate-100 shadow-sm bg-white">
                                    <table class="w-full text-xs text-left">
                                        <thead class="bg-slate-50/80 text-slate-500 uppercase font-black text-[10px] tracking-wider">
                                            <tr>
                                                <th class="px-5 py-4">Insumo / Gasto</th>
                                                <th class="px-5 py-4 text-center">Unidad</th>
                                                <th class="px-5 py-4 text-center">Cantidad</th>
                                                <th class="px-5 py-4 text-right">P. Unitario</th>
                                                <th class="px-5 py-4 text-right">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody class="divide-y divide-slate-50">
                                            ${
                                                productProvisions.length > 0
                                                    ? productProvisions
                                                          .map(
                                                              (p: any) => `
                                                <tr class="hover:bg-slate-50/50 transition-colors">
                                                    <td class="px-5 py-3 text-slate-700 font-semibold">${p.item}</td>
                                                    <td class="px-5 py-3 text-center text-slate-500 font-medium">${p.unit}</td>
                                                    <td class="px-5 py-3 text-center font-mono font-bold text-slate-600">${p.monthlyQuantity}</td>
                                                    <td class="px-5 py-3 text-right font-mono font-bold text-slate-600">${format(p.unitPrice)}</td>
                                                    <td class="px-5 py-3 text-right font-mono font-bold text-indigo-600">${format(parseFloat(p.monthlyQuantity) * parseFloat(p.unitPrice))}</td>
                                                </tr>
                                            `,
                                                          )
                                                          .join("")
                                                    : `
                                                <tr>
                                                    <td colspan="5" class="px-5 py-8 text-center text-slate-400 italic bg-slate-50/30">
                                                        No hay insumos registrados para este producto.
                                                    </td>
                                                </tr>
                                            `
                                            }
                                        </tbody>
                                        <tfoot class="bg-indigo-50/30 border-t border-indigo-100/50">
                                            <tr>
                                                <td colspan="4" class="px-5 py-3 text-right font-black text-indigo-400 uppercase text-[9px] tracking-widest">Costo Total Producto</td>
                                                <td class="px-5 py-3 text-right font-black text-indigo-700 font-mono text-sm">${format(subTotal)}</td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        `;
                        provisionsContainer.innerHTML += sectionHtml;
                    });

                    // General Total Summary Block
                    const globalTotalHtml = `
                        <div class="mt-8 pt-8 border-t border-slate-100 flex justify-end">
                            <div class="relative group">
                                <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl blur opacity-25 group-hover:opacity-40 transition duration-1000"></div>
                                <div class="relative flex items-center gap-6 bg-white px-8 py-5 rounded-2xl border border-slate-100 shadow-xl shadow-indigo-50">
                                    <div class="flex flex-col border-r border-slate-100 pr-6">
                                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-1">Total General</span>
                                        <span class="text-[9px] font-medium text-slate-300 italic">Provisiones G.A.V.</span>
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-2xl font-black text-indigo-600 font-mono leading-none">${format(plan.totalGeneralProvisions)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    provisionsContainer.innerHTML += globalTotalHtml;
                }
            }
            renderFinancialTable(
                "financing-table",
                plan.financingItems,
                ["Concepto", "Monto", "Fuente"],
                (f: any) => [f.concept, format(f.amount), f.source],
            );

            // Projections Table
            renderProjectionsTable(plan.projections, format);

            // Indicators
            setSafe("summary-profit", format(plan.netProfit));
            setSafe("summary-investment", format(plan.totalCost));
            setSafe("van-result", format(plan.van));
            setSafe(
                "tir-result",
                (parseFloat(plan.tir) * 100).toFixed(2) + "%",
            );
            setSafe("bc-result", parseFloat(plan.benefitCostRatio).toFixed(2));
            setSafe("payback-result", plan.paybackPeriod);
            setSafe(
                "financial-conclusion",
                plan.financialConclusion || "Sin conclusión generada.",
            );

            // Rates
            setSafe("rate-growth", (plan.growthRate * 100).toFixed(2) + "%");
            setSafe(
                "rate-price-growth",
                (plan.priceGrowthRate * 100).toFixed(2) + "%",
            );
            setSafe(
                "rate-inflation",
                (plan.inflationRate * 100).toFixed(2) + "%",
            );
            setSafe(
                "rate-salary-increase",
                (plan.salaryIncreaseRate * 100).toFixed(2) + "%",
            );
            setSafe(
                "rate-discount",
                (plan.discountRate * 100).toFixed(2) + "%",
            );

            // Images Gallery
            const gallery = document.getElementById("images-gallery");
            if (gallery && plan.images && plan.images.length > 0) {
                gallery.innerHTML = plan.images
                    .map((img: any) => {
                        const imgUrl = img.url.startsWith("http")
                            ? img.url
                            : `http://localhost:3000${img.url}`;
                        return `
                        <a href="${imgUrl}" target="_blank" class="group relative aspect-square rounded-xl overflow-hidden border bg-slate-50 hover:border-indigo-500 transition-all shadow-sm">
                            <img src="${imgUrl}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" />
                            <div class="absolute inset-0 bg-black/0 group-hover:bg-black/20 transition-colors flex items-center justify-center">
                                <svg class="w-6 h-6 text-white opacity-0 group-hover:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                            </div>
                        </a>
                    `;
                    })
                    .join("");
            } else if (gallery) {
                gallery.innerHTML =
                    '<p class="text-xs text-slate-400 italic col-span-4">No se han cargado anexos gráficos.</p>';
            }

            // Render Documents List
            const docsList = document.getElementById("documents-list");
            const token = localStorage.getItem("token");
            if (docsList && plan.documents && plan.documents.length > 0) {
                docsList.innerHTML = plan.documents
                    .map((doc: any, index: number) => {
                        const date = new Date(
                            doc.createdAt,
                        ).toLocaleDateString();
                        const fileUrl = doc.filePath.startsWith("http")
                            ? doc.filePath
                            : `http://localhost:3000${doc.filePath}?token=${token}`;
                        return `
                        <li class="flex items-center justify-between p-3 bg-slate-50 rounded-xl border border-slate-100 hover:border-indigo-200 transition-colors">
                            <div class="flex flex-col">
                                <span class="text-xs font-bold text-slate-700">Versión #${plan.documents.length - index}</span>
                                <span class="text-[10px] text-slate-400 font-medium">${date}</span>
                            </div>
                            <div class="flex gap-2">
                                <button class="btn-delete-doc text-red-600 hover:bg-white p-1.5 rounded-lg border border-transparent hover:border-red-100 transition-all" data-id="${doc.id}" title="Eliminar documento">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                </button>
                                <a href="${fileUrl}" download="plan_economico_${doc.id}.docx" class="text-green-600 hover:bg-white p-1.5 rounded-lg border border-transparent hover:border-green-100 transition-all" title="Descargar">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a2 2 0 002 2h12a2 2 0 002-2v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                                </a>
                            </div>
                        </li>`;
                    })
                    .join("");

                // Attach Delete Listeners
                document.querySelectorAll(".btn-delete-doc").forEach((btn) => {
                    btn.addEventListener("click", (e) => {
                        const target = e.currentTarget as HTMLElement;
                        const id = target.dataset.id;
                        openSecurityModal("delete-document", id!);
                    });
                });
            } else {
                if (docsList)
                    docsList.innerHTML =
                        '<p class="text-xs text-slate-400 italic text-center py-4">No hay documentos generados aún.</p>';
            }

            // Setup Export Button
            const exportBtn = document.getElementById("export-btn");
            exportBtn?.addEventListener("click", () => {
                const url = `http://localhost:3000/api/binary/plans/${planId}/export?token=${token}`;
                window.open(url, "_blank");
            });

            document.getElementById("loading")?.classList.add("hidden");
            document.getElementById("content")?.classList.remove("hidden");
        } catch (error) {
            console.error("Error loading plan:", error);
            document.getElementById("loading")!.innerHTML =
                '<p class="text-red-500">Error al cargar datos complejos.</p>';
        }
    }

    function renderSimpleTable(
        containerId: string,
        items: any[],
        headers: string[],
        keys: string[],
    ) {
        const container = document.getElementById(containerId);
        if (!container) return;
        if (!items || items.length === 0) {
            container.innerHTML =
                '<p class="text-slate-400 text-xs italic">Sin registros.</p>';
            return;
        }
        let html = `<table class="w-full text-xs text-left"><thead class="bg-slate-50 text-slate-500 uppercase"><tr>`;
        headers.forEach((h) => (html += `<th class="px-4 py-2">${h}</th>`));
        html += `</tr></thead><tbody>`;
        items.forEach((item) => {
            html += `<tr class="border-b border-slate-50">`;
            keys.forEach(
                (k) =>
                    (html += `<td class="px-4 py-2 text-slate-700">${item[k] || "N/A"}</td>`),
            );
            html += `</tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    function renderFinancialTable(
        containerId: string,
        items: any[],
        headers: string[],
        mapFn: any,
    ) {
        const container = document.getElementById(containerId);
        if (!container) return;
        if (!items || items.length === 0) {
            container.innerHTML =
                '<p class="text-slate-400 text-xs italic">Sin datos registrados.</p>';
            return;
        }
        let html = `<table class="w-full text-xs text-left"><thead class="bg-slate-50 text-slate-500 uppercase"><tr>`;
        headers.forEach((h) => (html += `<th class="px-4 py-2">${h}</th>`));
        html += `</tr></thead><tbody>`;
        items.forEach((item) => {
            html += `<tr class="border-b border-slate-50">`;
            mapFn(item).forEach(
                (val: any) => (html += `<td class="px-4 py-2">${val}</td>`),
            );
            html += `</tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    function renderProjectionsTable(projections: any[], format: any) {
        const container = document.getElementById("projections-table");
        if (!container || !projections || projections.length === 0) return;
        let html = `<table class="w-full text-xs text-left"><thead class="bg-slate-100 text-slate-600 uppercase"><tr><th class="px-4 py-2">Concepto</th>`;
        projections.forEach(
            (p) =>
                (html += `<th class="px-4 py-2 text-center">Año ${p.year}</th>`),
        );
        html += `</tr></thead><tbody>`;
        const rows = [
            { label: "Ingresos", key: "revenue" },
            { label: "EBIT", key: "ebit" },
            { label: "Utilidad Neta", key: "netProfit" },
            {
                label: "Flujo Caja",
                key: "cashFlow",
                color: "text-blue-600 font-bold",
            },
        ];
        rows.forEach((row) => {
            html += `<tr class="border-b border-slate-100"><td class="px-4 py-2 font-bold bg-slate-50">${row.label}</td>`;
            projections.forEach(
                (p) =>
                    (html += `<td class="px-4 py-2 text-center ${row.color || ""}">${format(p[row.key])}</td>`),
            );
            html += `</tr>`;
        });
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    loadPlan();

    // Security Modal Logic
    const securityModal = document.getElementById(
        "security_confirm_modal",
    ) as HTMLDialogElement;
    const securityForm = document.getElementById(
        "security-confirm-form",
    ) as HTMLFormElement;
    const securityPasswordInput = document.getElementById(
        "security-password",
    ) as HTMLInputElement;
    const securityError = document.getElementById("security-error");
    const securitySubmitBtn = document.getElementById("security-submit-btn");

    function openSecurityModal(action: string, targetId: string) {
        (
            document.getElementById("security-action-type") as HTMLInputElement
        ).value = action;
        (
            document.getElementById("security-target-id") as HTMLInputElement
        ).value = targetId;
        securityPasswordInput.value = "";
        securityError?.classList.add("hidden");
        securityModal.showModal();
    }

    securityForm?.addEventListener("submit", async (e) => {
        e.preventDefault();
        const action = (
            document.getElementById("security-action-type") as HTMLInputElement
        ).value;
        const targetId = (
            document.getElementById("security-target-id") as HTMLInputElement
        ).value;
        const password = securityPasswordInput.value;

        if (securitySubmitBtn) {
            securitySubmitBtn.innerHTML =
                '<span class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></span>';
            (securitySubmitBtn as HTMLButtonElement).disabled = true;
        }

        try {
            await api.verifyPassword(password);

            if (action === "delete-document") {
                await api.deleteDocument(parseInt(targetId));
                loadPlan(); // Reload to refresh the list
            }

            securityModal.close();
        } catch (error: any) {
            console.error(error);
            securityError?.classList.remove("hidden");
        } finally {
            if (securitySubmitBtn) {
                securitySubmitBtn.innerHTML =
                    "<span>Confirmar y Eliminar</span>";
                (securitySubmitBtn as HTMLButtonElement).disabled = false;
            }
        }
    });

    document
        .getElementById("security-cancel-btn")
        ?.addEventListener("click", () => securityModal.close());
    document
        .getElementById("btn-close-security-modal")
        ?.addEventListener("click", () => securityModal.close());
</script>
